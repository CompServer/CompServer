{% extends "skeleton.html" %}
{% load i18n %}
{% load mathfilters %}

{% block head %}

<style>

.bracket {
    height:{{bracket_dict.bracketHeight}}px; 
    width:{{bracket_dict.bracketWidth}}px;
}

.round {
    height: {{ bracket_dict.roundHeight }}px; 
    width: {{ bracket_dict.roundWidth }}px;
}
</style>

{% endblock %}

{% block content %}
<h1>
    {% if tournament.is_judgable %} 
        <i class="bi-activity" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Single Elimination Tournament" %}: {{ tournament.event.name }}
    {% elif tournament.is_complete %} 
        <i class="bi-check2-circle" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Single Elimination Tournament" %}: {{ tournament.event.name }}
    {% elif tournament.is_closed %} 
        <i class="bi-x-circle" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Single Elimination Tournament" %}: {{ tournament.event.name }}
    {% elif tournament.is_in_setup %}
        <i class="bi bi-device-ssd" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Single Elimination Tournament" %}: {{ tournament.event.name }}
    {% elif competition.is_archived %}
        <i class="bi-archive" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Single Elimination Tournament" %}: {{ tournament.event.name }} <small>{% translate "You can see this archived item because you are signed in as a superuser." %}</small>
    {% endif %}
    ({{ tournament.points|floatformat:"0" }} {% if points != 1 %}{% translate "points" %} {% else %} {% translate "point" %} {% endif %})
    {% if user.is_staff %}
        <form class="form-inline my-2 my-md-0 justify-content-end d-inline ps-2" action="/tournament/{{ tournament.id }}/?next=tournament&id={{ tournament.id }}" method="POST" id="status">
            {% csrf_token %}
            <div class="input-group d-inline">
                <select name="status" onchange="this.form.submit();">
                    {% for value, translated_value in form.status.field.choices %}
                        <option value="{{ value }}" {% if tournament.status == value %}selected{% endif %}>{{ translated_value }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    {% endif %} 
</h1>
{% comment %} not sure how to show match times here, bc I need to know exactly how they work {% endcomment %}
{% if tournament.match_set.exists %}
<div class="bracket">
    {% for round_data in bracket_dict.round_data %}
    <div class="round">
        {% for match_data in round_data.match_data %}
        <div class="match" style="height: {{ match_data.match_height }}px; width: {{ match_data.match_width }}px;">

            {{match_data.connector_data.midpoint_index}}

            <div class="center"
                style="height: {{ match_data.center_height }}px; margin-top: {{ match_data.center_top_margin }}px; ">
                
                {% with connector_height=match_data.match_height|mul:match_data.connector_data.match_offset_mult %}    
                <div class="connector-front {{ match_data.connector_data.connector }} highlight-{{match_data.connector_data.winner_id}}" onclick=""
                style=" cursor: default;
                height: {{connector_height|add:match_data.connector_data.team_index_offset|abs}}px;
                width: {{match_data.connector_data.connector_width_actual}}px;
                right: -{{match_data.connector_data.connector_width_actual}}px;
                {% if  match_data.connector_data.connector == "connector-up" %}
                bottom: {{ match_data.connector_data.vertical_margin }}px;
                {% else %}
                top: {{ match_data.connector_data.vertical_margin|sub:1 }}px;
                {% endif %}
                {%endwith %}
                ">
                    <div class="connector-end highlight-{{match_data.connector_data.winner_id}}" 
                    style="width: {{bracket_dict.connectorWidth|sub:match_data.connector_data.connector_width_actual|add:2}}px;
                    right: -{{bracket_dict.connectorWidth|sub:match_data.connector_data.connector_width_actual|add:4}}px;
                    height: 3px;"></div>
                </div>
                
                {% for curr_team in match_data.team_data %}
                    <div class="team highlight-{{curr_team.team_id}}"
                        style="height: {{bracket_dict.team_height}}px; width: {{ match_data.match_width }}px; 
                        {%if curr_team.won %}background-color: #fff5a8;{%endif%} cursor: pointer;"
                        onclick="location.href='{% url 'competitions:judge_match' curr_team.match_id %}';"
                        onmouseover="highlight({{curr_team.team_id}})" onmouseout="dehighlight({{curr_team.team_id}})">
                        {{ curr_team.name }}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% else %}
    {% if user.is_superuser %}
        <form class="form-inline my-2 my-md-0 justify-content-end" action="/tournament/{{ tournament.id }}/generate/" method="POST" id="status">
            {% csrf_token %}
            <input type="submit" value="Generate Matches">
        </form>
    {% endif %}
{% endif %}

<script>
function highlight(num) {
    document.querySelectorAll(".highlight-"+num).forEach((element)=>{
        element.style.borderColor = "#2ec4b6";
        if (element.className.includes("connector")) {
            element.style.borderWidth = "2px"
        } else {
            element.style.borderWidth = "1px"
        }
        
    })
}
function dehighlight(num) {
    document.querySelectorAll(".highlight-"+num).forEach((element)=>{
        element.style.borderColor = "black";
        if (element.className.includes("connector")) {
            element.style.borderWidth = "2px"
        } else {
            element.style.borderWidth = "1px"
        }
    })
}
</script>

{% endblock %}



