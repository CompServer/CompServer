{% extends 'skeleton.html' %}
{% load i18n %}
<style>
    .bracket {
        width:{{bracket_dict.bracketWidth}}px;
    }
    
    .round {
        height: {{ bracket_dict.roundHeight|add:30 }}px; 
        width: {{ bracket_dict.roundWidth }}px;
    }
    
    .round-header {
        height: {{bracket_dict.team_height}}px;
        width: {{ bracket_dict.match_width }}px;
    }
</style>
{% block content %}
    <h1>{% if tournament.is_judgable %} 
            <i class="bi-activity" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Preliminary Tournament" %}: {{ tournament.event.name }}
        {% elif tournament.is_complete %} 
            <i class="bi-check2-circle" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Preliminary Tournament" %}: {{ tournament.event.name }}
        {% elif tournament.is_closed %} 
            <i class="bi-x-circle" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Preliminary Tournament" %}: {{ tournament.event.name }}
        {% elif tournament.is_in_setup %}
            <i class="bi bi-device-ssd" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Preliminary Tournament" %}: {{ tournament.event.name }}
        {% elif competition.is_archived %}
            <i class="bi-archive" title="{{ competition.status }}"></i> {{ tournament.competition.name }} {% translate "Preliminary Tournament" %}: {{ tournament.event.name }} <small>You can see this archived item because you are signed in as a superuser.</small>
        {% endif %}
        {% if user.is_staff %}
            <form class="form-inline my-2 my-md-0 justify-content-end d-inline ps-2" action="/tournament/{{ tournament.id }}/?next=tournament&id={{ tournament.id }}" method="POST" id="status">
                {% csrf_token %}
                <div class="input-group d-inline">
                    <select name="status" onchange="this.form.submit();">
                        {% for value, translated_value in form.status.field.choices %}
                            <option value="{{ value }}" {% if tournament.status == value %}selected{% endif %}>{{ translated_value }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        {% endif %} 
    </h1>
    <hr>
    {% if tournament.match_set.all %}
        <div class="bracket">
            {% for round_data in bracket_dict.round_data %}
            <div class="round">
                {% translate "Round" %} {{ forloop.counter }}
                {% for match_data in round_data.match_data %}
                <div class="match" style="height: {{ match_data.match_height }}px; width: {{ match_data.match_width }}px;" id="{{ match_data.id }}">
                    <div class="center"
                        style="height: {{ match_data.center_height }}px; margin-top: {{ match_data.center_top_margin }}px; ">
                        {% if match_data.team_data != None %}
                            {{ match_data.arena }} {% if user.is_staff %} <small><small id="match_id">(ID: {{ match_data.id }})</small></small> {% endif %}
                            {% for team_data in match_data.team_data %}
                                <div class="team highlight-{{team_data.team_id}} {%if team_data.won %}won{%endif%}"
                                    style="height: {{bracket_dict.team_height}}px; width: {{ bracket_dict.match_width }}px; cursor: pointer;
                                    background-color:{% if team_data.won %} #fff5a8 {% else %} {{ match_data.arena.color }} {% endif %}; 
                                    {% if forloop.first %} border-top-right-radius: 8px; border-top-left-radius: 8px; {% endif %}
                                    {% if forloop.last %} border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; {% endif %}"
                                    onclick="location.href='{% url 'competitions:judge_match' team_data.match_id %}';"
                                    onmouseover="highlight({{team_data.team_id}}, {{ team_data.match_id }})" onmouseout="dehighlight({{team_data.team_id}}, '{{ match_data.arena.color }}')">
                                    <p style="color: {% if match_data.arena.is_dark %} white; {% endif %} ">{{ team_data.name }}</p>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div> 
                </div>
                {% endfor %}    
            </div>
            {% endfor %}
        </div>
        <div class="row d-flex justify-content-center">
            <span><b>Team Rankings</b> ({% translate "Points Per Win: "%} {{ tournament.points_per_win }}, {% translate "Points Per Tie: "%} {{ tournament.points_per_tie }}, {% translate "Points Per Loss: "%} {{ tournament.points_per_loss }})</span>
            {% for team, points in team_wins.items %}
                <li class="nav-item">
                    {% if team in winning_teams %}
                        <b><font color="#ff0000">{{ team.name }}</font></b>:
                    {% else %}
                        <b>{{ team.name }}</b>:
                    {% endif %}
                    {{ points }} {% if points == 1 %} {% translate "point" %} {% else %} {% translate "points" %} {% endif %}
                </li>
            {% endfor %}
        </div>
        <hr>
        {% if user.is_superuser and tournament.is_in_setup %}
            <a href="{% url 'competitions:swap_matches' tournament.id %}" class="btn btn-secondary">{% translate "Swap Match Teams" %}</a>
            <a href="{% url 'competitions:edit_tournament' tournament.id %}" class="btn btn-secondary">{% translate "Edit Tournament" %}</a>
            {% comment %} <br><r>
            <a href="{% url "competitions:arena_color" tournament.competition.id %}" class="btn btn-secondary">{% translate "Change Arena Colors" %}</a> {% endcomment %}
        {% endif %}
        <a href="{% url 'competitions:competition' tournament.competition.id %}" class="btn btn-secondary">{% translate "Go Back To Competition" %}</a>
    {% else %}
        <form class="form-inline my-2 my-md-0 justify-content-end" action="/tournament/{{ tournament.id }}/generate/" method="POST" id="status">
            {% csrf_token %}
            <input type="submit" value={% translate "Generate Matches" %}>
        </form>
    {% endif %}
    <script>
        function highlight(num, num2) {
            document.querySelectorAll(".highlight-"+num).forEach((element)=>{
                element.style.borderColor = "#2ec4b6";
                if (element.className.includes("won")) {
                    if (element.className.includes("team")) {
                        element.style.backgroundColor = "lightgreen";
                    }
                } else {
                    if (element.className.includes("team")) {
                        element.style.borderColor = "#c9184a";
                        element.style.backgroundColor= "#ff4d6d"
                    }
                    
                }
            })
        }
        function dehighlight(num, color) {
            console.log(color);
            document.querySelectorAll(".highlight-"+num).forEach((element)=>{
                element.style.borderColor = "black";
                if (element.className.includes("won")) {
                    if (element.className.includes("team")) {
                        element.style.backgroundColor = "#fff5a8";
                    }
                } else {
                    if (element.className.includes("team")) {
                        element.style.backgroundColor = color;
                    }
                }
            })
        }
    </script>
    
    {% comment %} <h3>{% translate "Matches" %}</h3> {% endcomment %}
{% endblock %}
